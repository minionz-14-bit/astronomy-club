<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظريات - نادي الفلك السوري</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f4; padding: 20px; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: auto; }
    input, textarea { width: 100%; padding: 10px; margin: 10px 0; }
    button { padding: 10px 20px; background: #444; color: white; border: none; cursor: pointer; }
    button:hover { background: #666; }
    .blog-post { background: white; margin: 20px auto; padding: 20px; border-radius: 10px; max-width: 600px; }
    .blog-post img { max-width: 100%; margin-top: 10px; border-radius: 6px; }
    h1 { text-align: center; }
    h3 { margin-bottom: 8px; }
    p { white-space: pre-line; }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
</head>
<body>
<!-- 🔙 Back to home button -->
<div style="text-align: center; margin-bottom: 1rem;">
  <a href="Index.html" style="
    display: inline-block;
    background-color: #c2b280;
    color: #014421;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    font-size: 1rem;
  ">
    🔙 العودة إلى الصفحة الرئيسية
  </a>
</div>

<h1>✍️ صفحة نظريات</h1>

<form id="blogForm">
  <label for="title">عنوان النظرية:</label>
  <input type="text" id="title" required />

  <label for="content">النص المختصر:</label>
  <textarea id="content" rows="4" required></textarea>

  <label for="image">صورة (اختياري):</label>
  <input type="file" id="image" accept="image/*" />

  <button type="submit">نشر النظرية</button>
</form>

<div id="blogs"></div>

<!-- Cloudinary Upload Widget + Firebase SDKs already included in <head> -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDVzkSxKGc2jR43aYnYP6QX03B37WVRVok",
    authDomain: "syrianyouthastro.firebaseapp.com",
    projectId: "syrianyouthastro",
    storageBucket: "syrianyouthastro.appspot.com",
    messagingSenderId: "105047646564",
    appId: "1:105047646564:web:7901e202f6467b0b745a71",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let uploadedImageUrl = null;

  // Cloudinary Upload Widget
  const cloudinaryWidget = cloudinary.createUploadWidget({
    cloudName: 'dpgkvqpef',
    uploadPreset: 'unsigned_preset',
    multiple: false,
    sources: ['local', 'url', 'camera'],
    resourceType: 'image'
  }, (error, result) => {
    if (!error && result.event === "success") {
      uploadedImageUrl = result.info.secure_url;
      document.getElementById('imagePreview').src = uploadedImageUrl;
      document.getElementById('imagePreview').style.display = 'block';
    }
  });

  // Hide the image input field and replace it with a widget button
  document.addEventListener("DOMContentLoaded", () => {
    const imageInput = document.getElementById('image');
    imageInput.style.display = 'none';

    const uploadBtn = document.createElement('button');
    uploadBtn.textContent = '📸 اختيار صورة من جهازك';
    uploadBtn.type = 'button';
    uploadBtn.style.marginBottom = '10px';
    uploadBtn.onclick = () => cloudinaryWidget.open();

    imageInput.parentNode.insertBefore(uploadBtn, imageInput);

    const preview = document.createElement('img');
    preview.id = 'imagePreview';
    preview.style.maxWidth = '100%';
    preview.style.marginTop = '10px';
    preview.style.display = 'none';
    imageInput.parentNode.insertBefore(preview, imageInput.nextSibling);
  });

  // Blog post form submission
  const form = document.getElementById('blogForm');
  const blogsDiv = document.getElementById('blogs');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title || !content) {
      alert('يرجى تعبئة العنوان والنص.');
      return;
    }

    const user = auth.currentUser;
    if (!user) {
      alert('❗ يجب تسجيل الدخول لنشر النظرية.');
      return;
    }

    try {
      await db.collection('nathariyat_posts').add({
        title,
        content,
        imageUrl: uploadedImageUrl || null,
        userId: user.uid,
        email: user.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      alert('✅ تم نشر النظرية بنجاح!');
      form.reset();
      uploadedImageUrl = null;
      document.getElementById('imagePreview').style.display = 'none';
    } catch (error) {
      alert('❌ حدث خطأ أثناء نشر النظرية: ' + error.message);
    }
  });

  function createBlogPostElement(post) {
    const div = document.createElement('div');
    div.className = 'blog-post';
    let html = `<h3>${escapeHtml(post.title)}</h3><p>${escapeHtml(post.content)}</p>`;
    if (post.imageUrl) {
      html += `<img src="${post.imageUrl}" alt="صورة للنظرية" />`;
    }
    div.innerHTML = html;
    return div;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function loadBlogs() {
    db.collection('nathariyat_posts')
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        blogsDiv.innerHTML = '';
        snapshot.forEach(doc => {
          const post = doc.data();
          blogsDiv.appendChild(createBlogPostElement(post));
        });
      }, error => {
        console.error('Error loading posts:', error);
      });
  }

  // Check login and load blogs
  auth.onAuthStateChanged(user => {
    if (!user) {
      alert("🛑 يجب تسجيل الدخول لنشر النظريات.");
      document.getElementById('blogForm').style.display = 'none';
    }
    loadBlogs();
  });
</script>


</body>
</html>
