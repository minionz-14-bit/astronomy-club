<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظريات - نادي الفلك السوري</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f4; padding: 20px; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: auto; }
    input, textarea { width: 100%; padding: 10px; margin: 10px 0; }
    button { padding: 10px 20px; background: #444; color: white; border: none; cursor: pointer; }
    button:hover { background: #666; }
    .blog-post { background: white; margin: 20px auto; padding: 20px; border-radius: 10px; max-width: 600px; }
    .blog-post img { max-width: 100%; margin-top: 10px; border-radius: 6px; }
    h1 { text-align: center; }
    h3 { margin-bottom: 8px; }
    p { white-space: pre-line; }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
</head>
<body>

<h1>✍️ صفحة نظريات</h1>

<form id="blogForm">
  <label for="title">عنوان النظرية:</label>
  <input type="text" id="title" required />

  <label for="content">النص المختصر:</label>
  <textarea id="content" rows="4" required></textarea>

  <label for="image">صورة (اختياري):</label>
  <input type="file" id="image" accept="image/*" />

  <button type="submit">نشر النظرية</button>
</form>

<div id="blogs"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDVzkSxKGc2jR43aYnYP6QX03B37WVRVok",
    authDomain: "syrianyouthastro.firebaseapp.com",
    projectId: "syrianyouthastro",
    storageBucket: "syrianyouthastro.appspot.com",
    messagingSenderId: "105047646564",
    appId: "1:105047646564:web:7901e202f6467b0b745a71",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const form = document.getElementById('blogForm');
  const blogsDiv = document.getElementById('blogs');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const imageInput = document.getElementById('image');
    const imageFile = imageInput.files[0];

    if (!title || !content) {
      alert('يرجى تعبئة العنوان والنص.');
      return;
    }

    try {
      let imageUrl = null;

      if (imageFile) {
        const formData = new FormData();
        formData.append("file", imageFile);
        formData.append("upload_preset", "unsigned_preset");

        const response = await fetch("https://api.cloudinary.com/v1_1/dpgkvqpef/image/upload", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        imageUrl = data.secure_url;
      }

      await db.collection('nathariyat_posts').add({
        title,
        content,
        imageUrl: imageUrl || null,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      alert('✅ تم نشر النظريّة بنجاح!');
      form.reset();
    } catch (error) {
      alert('❌ حدث خطأ أثناء نشر النظريّة: ' + error.message);
    }
  });

  function createBlogPostElement(post) {
    const div = document.createElement('div');
    div.className = 'blog-post';

    let html = `<h3>${escapeHtml(post.title)}</h3><p>${escapeHtml(post.content)}</p>`;
    if (post.imageUrl) {
      html += `<img src="${post.imageUrl}" alt="صورة للنظرية" />`;
    }
    div.innerHTML = html;
    return div;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function loadBlogs() {
    db.collection('nathariyat_posts')
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        blogsDiv.innerHTML = '';
        snapshot.forEach(doc => {
          const post = doc.data();
          blogsDiv.appendChild(createBlogPostElement(post));
        });
      }, error => {
        console.error('Error loading posts:', error);
      });
  }

  loadBlogs();
</script>

</body>
</html>
